<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="style.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <title>Comtrade API Tester</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <h2>Comtrade API Query Panel</h2>
    <div class="flex">
        <form id="finalForm">
            <h3>Final Data Query</h3>
            <input name="typeCode" value="C" required><br>
            <input name="freqCode" value="M" required><br>
            <input name="clCode" value="HS" required><br>
            <input name="period" value="202205" required><br>
            <input name="reporterCode" value="36" required><br>
            <input name="cmdCode" value="91" required><br>
            <input name="flowCode" value="M" required><br>
            <button type="submit">Fetch Final Data</button>
        </form>

        <form id="tariffForm">
            <h3>Tariffline Data Query</h3>
            <input name="typeCode" value="C" required><br>
            <input name="freqCode" value="M" required><br>
            <input name="clCode" value="HS" required><br>
            <input name="period" value="202205" required><br>
            <input name="reporterCode" value="36" required><br>
            <input name="cmdCode" value="91" required><br>
            <input name="flowCode" value="M" required><br>
            <button type="submit">Fetch Tariffline Data</button>
        </form>
    </div>

    <div id="results">
        <h3>Results:</h3>
        <div class="column-filter" id="columnFilterContainer"></div>

        <button onclick="toggleCharts()" id="toggleChartBtn">üìä Show Charts</button>
        <div id="chartContainer" style="display:none">
            <h4 id="chart1Title">Chart 1</h4>
            <canvas id="chart1" height="120"></canvas>
            <h4 id="chart2Title">Chart 2</h4>
            <canvas id="chart2" height="120"></canvas>
        </div>

        <div id="tableContainer">No data yet.</div>
    </div>

    <script>
        const CLOUD_RUN_BASE = "https://uncomtrade-web-app-903823352744.europe-west1.run.app";
        let lastData = null;
        let chart1Instance = null;
        let chart2Instance = null;
        let activeForm = "final";

        const finalDefaultCols = [
            "refPeriodId", "reporterDesc", "partnerDesc", "customsCode", "motDesc",
            "altQty", "netWgt", "grossWgt", "cifvalue", "fobvalue", "primaryValue"
        ];

        const tariffDefaultCols = [
            "refPeriodId", "reporterDesc", "partnerDesc", "cmdCode", "cmdDesc",
            "qty", "qtyUnitAbbr", "altQty", "netWgt", "grossWgt", "fobvalue"
        ];

        function toggleCharts() {
            const chartDiv = document.getElementById("chartContainer");
            const btn = document.getElementById("toggleChartBtn");
            if (chartDiv.style.display === "none") {
                chartDiv.style.display = "block";
                btn.innerText = "üìâ Hide Charts";
            } else {
                chartDiv.style.display = "none";
                btn.innerText = "üìä Show Charts";
            }
        }

        function renderColumnFilter(columns, defaultChecked) {
            const container = document.getElementById("columnFilterContainer");
            container.innerHTML = "";
            const allKeys = Object.keys(columns[0] ?? {});
            allKeys.forEach(key => {
                const isChecked = defaultChecked.includes(key);
                const label = document.createElement("label");
                label.innerHTML = `<input type="checkbox" value="${key}" ${isChecked ? "checked" : ""}>${key}`;
                container.appendChild(label);
            });
        }

        function getSelectedColumns() {
            return Array.from(document.querySelectorAll('#columnFilterContainer input:checked')).map(i => i.value);
        }

        function destroyCharts() {
            if (chart1Instance) chart1Instance.destroy();
            if (chart2Instance) chart2Instance.destroy();
        }

        function renderCharts(data) {
            const ctx1 = document.getElementById('chart1').getContext('2d');
            const ctx2 = document.getElementById('chart2').getContext('2d');

            destroyCharts();

            if (activeForm === "final") {
                document.getElementById("chart1Title").innerText = "Top 10 Partner by Net Weight";
                document.getElementById("chart2Title").innerText = "Transport Method Share";

                const topPartners = data.slice(0, 10);
                chart1Instance = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: topPartners.map(d => d.partnerDesc),
                        datasets: [{
                            label: 'Net Weight',
                            data: topPartners.map(d => d.netWgt || 0),
                            backgroundColor: '#007acc'
                        }]
                    },
                    options: { responsive: true }
                });

                const motCounts = {};
                data.forEach(d => {
                    const mot = d.motDesc || "Unknown";
                    motCounts[mot] = (motCounts[mot] || 0) + 1;
                });

                chart2Instance = new Chart(ctx2, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(motCounts),
                        datasets: [{
                            label: 'Transport Mode',
                            data: Object.values(motCounts),
                            backgroundColor: ['#007acc', '#8ecae6', '#219ebc', '#023047']
                        }]
                    },
                    options: { responsive: true }
                });
            } else if (activeForm === "tariff") {
                document.getElementById("chart1Title").innerText = "Top 10 Products by Quantity";
                document.getElementById("chart2Title").innerText = "Top 10 Partners by FOB Value";

                const topProducts = data.slice(0, 10);
                chart1Instance = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: topProducts.map(d => d.cmdDesc || d.cmdCode),
                        datasets: [{
                            label: 'Quantity',
                            data: topProducts.map(d => d.qty || 0),
                            backgroundColor: '#f8961e'
                        }]
                    },
                    options: { responsive: true }
                });

                const topFob = data
                    .filter(d => d.fobvalue)
                    .sort((a, b) => b.fobvalue - a.fobvalue)
                    .slice(0, 10);

                chart2Instance = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: topFob.map(d => d.partnerDesc),
                        datasets: [{
                            label: 'FOB Value',
                            data: topFob.map(d => d.fobvalue),
                            backgroundColor: '#f3722c'
                        }]
                    },
                    options: { responsive: true }
                });
            }
        }

        function renderTable(data) {
            lastData = data;
            const selectedColumns = getSelectedColumns();
            let html = "<table><thead><tr>" + selectedColumns.map(k => `<th>${k}</th>`).join("") + "</tr></thead><tbody>";

            html += data.map(row => {
                return "<tr>" + selectedColumns.map(k => {
                    let value = row[k] ?? "";
                    if (k === "motDesc") {
                        if (value.toLowerCase().includes("air")) value = "‚úàÔ∏è " + value;
                        else if (value.toLowerCase().includes("sea")) value = "üö¢ " + value;
                    }
                    return `<td>${value}</td>`;
                }).join("") + "</tr>";
            }).join("");

            html += "</tbody></table>";
            document.getElementById("tableContainer").innerHTML = html;
            renderCharts(data);
        }

        async function handleForm(endpoint, form, defaultCols, formName) {
            activeForm = formName;
            const params = new URLSearchParams(new FormData(form)).toString();
            const res = await fetch(`${CLOUD_RUN_BASE}/${endpoint}?${params}`);
            const json = await res.json();
            renderColumnFilter(json, defaultCols);
            renderTable(json);
        }

        document.getElementById("finalForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            await handleForm("final-data", e.target, finalDefaultCols, "final");
        });

        document.getElementById("tariffForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            await handleForm("tariffline-data", e.target, tariffDefaultCols, "tariff");
        });

        document.getElementById("columnFilterContainer").addEventListener("change", () => {
            if (lastData) renderTable(lastData);
        });
    </script>

    <div>&copy; True Digital Team 2025</div>
</body>

</html>