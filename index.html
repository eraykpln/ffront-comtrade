<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comtrade API Tester</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <h2>Comtrade API Query Panel</h2>

    <div class="flex">
        <!-- Final Data Form -->
        <form id="finalForm">
            <h3>Final Data Query</h3>
            <label>Data Type:</label>
            <select id="typeCodeFinal" name="typeCode" required>
                <option value="C">Commodity</option>
                <option value="S">Services</option>
            </select><br>
            <label>Frequency:</label>
            <select id="freqCodeFinal" name="freqCode" required>
                <option value="M">Monthly</option>
                <option value="A">Annual</option>
            </select><br>
            <label>Classification Code:</label>
            <input id="clCodeFinal" name="clCode" value="HS" required><br>
            <label>Period (YYYYMM):</label>
            <input id="periodFinal" name="period" value="202205" pattern="\d{6}" required><br>
            <label>Reporter Country:</label>
            <select id="reporterCodeFinal" name="reporterCode" required></select><br>
            <label>Partner Country:</label>
            <select id="partnerCodeFinal" name="partnerCode" required></select><br>
            <label>Commodity Code (HS6):</label>
            <input id="cmdCodeFinal" name="cmdCode" value="91" required><br>
            <label>Trade Flow:</label>
            <select id="flowCodeFinal" name="flowCode" required>
                <option value="M">Import</option>
                <option value="X">Export</option>
            </select><br>
            <button type="submit">Fetch Final Data</button>
        </form>

        <!-- Tariffline Data Form -->
        <form id="tariffForm">
            <h3>Tariffline Data Query</h3>
            <label>Data Type:</label>
            <select id="typeCodeTariff" name="typeCode" required>
                <option value="C">Commodity</option>
                <option value="S">Services</option>
            </select><br>
            <label>Frequency:</label>
            <select id="freqCodeTariff" name="freqCode" required>
                <option value="M">Monthly</option>
                <option value="A">Annual</option>
            </select><br>
            <label>Classification Code:</label>
            <input id="clCodeTariff" name="clCode" value="HS" required><br>
            <label>Period (YYYYMM):</label>
            <input id="periodTariff" name="period" value="202205" pattern="\d{6}" required><br>
            <label>Reporter Country:</label>
            <select id="reporterCodeTariff" name="reporterCode" required></select><br>
            <label>Partner Country:</label>
            <select id="partnerCodeTariff" name="partnerCode" required></select><br>
            <label>Commodity Code (HS6):</label>
            <input id="cmdCodeTariff" name="cmdCode" placeholder="e.g. 2701" required><br>
            <label>Trade Flow:</label>
            <select id="flowCodeTariff" name="flowCode" required>
                <option value="M">Import</option>
                <option value="X">Export</option>
            </select><br>
            <button type="submit">Fetch Tariffline Data</button>
        </form>
    </div>

    <!-- Pie Chart Only -->
    <button id="togglePieBtn" onclick="togglePieSection()">ðŸ¥§ Show Pie Chart</button>
    <div id="pieChartSection" style="display:none;margin-top:20px;">
        <h4>Select Column for Pie Chart:</h4>
        <select id="pieColumnSelect"></select>
        <div style="display:flex;gap:20px;align-items:center;">
            <canvas id="pieChart" width="300" height="300"></canvas>
        </div>
    </div>

    <!-- Results -->
    <div id="results">
        <h3>Results:</h3>
        <div id="columnFilterContainer" class="column-filter"></div>
        <div id="tableContainer">No data yet.</div>
    </div>

    <script>
        // Config & Globals
        const CLOUD_RUN_BASE = "https://uncomtrade-web-app-903823352744.europe-west1.run.app";
        let lastData = null, pieChartInstance = null, activeForm = "final";

        const finalCols = ["refPeriodId", "partnerDesc", "cmdDesc", "cmdCode", "cifvalue", "fobvalue", "netWgt", "altQty", "reporterDesc"];
        const tariffCols = ["refPeriodId", "reporterDesc", "partnerDesc", "cmdCode", "cmdDesc", "qty", "qtyUnitAbbr", "altQty", "netWgt", "grossWgt", "fobvalue"];
        const colName = { period: "DATE", partnerDesc: "Partner", cmdDesc: "Description", cmdCode: "HS CODE", cifvalue: "CIF ($)", fobvalue: "FOB ($)", netWgt: "NetWgt", altQty: "AltQty", flowDesc: "Flow", motDesc: "Transport", reporterDesc: "Reporter" };

        // Country List
        const countries = [{ code: "0", name: "World" }, { code: "36", name: "Australia" }, { code: "40", name: "Austria" }, { code: "50", name: "Bangladesh" }, { code: "76", name: "Brazil" }, { code: "124", name: "Canada" }, { code: "156", name: "China" }, { code: "276", name: "Germany" }, { code: "356", name: "India" }, { code: "392", name: "Japan" }, { code: "643", name: "Russia" }, { code: "792", name: "Turkey" }, { code: "826", name: "United Kingdom" }, { code: "840", name: "United States" }];
        function populateSelect(id) { const sel = document.getElementById(id); countries.forEach(c => { const o = document.createElement('option'); o.value = c.code; o.text = c.name; sel.appendChild(o); }); new Choices(sel, { searchEnabled: true, itemSelectText: '', shouldSort: true }); }
        document.addEventListener('DOMContentLoaded', () => { "reporterCodeFinal,partnerCodeFinal,reporterCodeTariff,partnerCodeTariff".split(',').forEach(populateSelect));});

        // UI toggles
        function togglePieSection() { const s = document.getElementById('pieChartSection'); const btn = document.getElementById('togglePieBtn'); if (s.style.display === 'none') { s.style.display = 'block'; btn.innerText = 'ðŸ¥§ Hide Pie Chart'; populatePieSelect(); } else { s.style.display = 'none'; btn.innerText = 'ðŸ¥§ Show Pie Chart'; pieChartInstance && pieChartInstance.destroy(); } }

        // Column filter
        function renderFilter(rows, defaults) { const c = document.getElementById('columnFilterContainer'); c.innerHTML = ''; if (!rows.length) return; Object.keys(rows[0]).forEach(k => { const l = document.createElement('label'); l.innerHTML = `<input type='checkbox' value='${k}' ${defaults.includes(k) ? 'checked' : ''}>${colName[k] || k}`; c.appendChild(l); }); }
        const selCols = () => Array.from(document.querySelectorAll('#columnFilterContainer input:checked')).map(e => e.value);

        // Table
        function renderTable(rows) { lastData = rows; const cols = selCols(); if (!cols.length || !rows.length) { document.getElementById('tableContainer').innerText = 'No data.'; return; } const head = cols.map(k => `<th>${colName[k] || k}</th>`).join(''); const body = rows.map(r => `<tr>${cols.map(k => `<td>${r[k] ?? ''}</td>`).join('')}</tr>`).join(''); document.getElementById('tableContainer').innerHTML = `<table><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table>`; }

        // Pie chart
        function populatePieSelect() { const sel = document.getElementById('pieColumnSelect'); sel.innerHTML = ''; selCols().forEach(k => { const o = document.createElement('option'); o.value = k; o.text = colName[k] || k; sel.appendChild(o); }); sel.onchange = () => drawPie(sel.value); if (sel.options.length) drawPie(sel.value); }
        function drawPie(col) { if (!lastData || !col) return; const grp = {}; lastData.forEach(r => { const key = r[col] || 'Unknown'; grp[key] = (grp[key] || 0) + 1; }); const ctx = document.getElementById('pieChart').getContext('2d'); pieChartInstance && pieChartInstance.destroy(); pieChartInstance = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(grp), datasets: [{ data: Object.values(grp) }] }, options: { responsive: true } }); }

        // API helper
        function normalize(j) { if (Array.isArray(j)) return j; if (j.data && Array.isArray(j.data)) return j.data; if (j.results && Array.isArray(j.results)) return j.results; return []; }
        async function fetchData(endpoint, form, defaults, name) { try { activeForm = name; const qs = new URLSearchParams(new FormData(form)); const res = await fetch(`${CLOUD_RUN_BASE}/${endpoint}?${qs}`); if (!res.ok) throw new Error(`HTTP ${res.status}`); const rows = normalize(await res.json()); if (!rows.length) throw new Error('No rows'); renderFilter(rows, defaults); renderTable(rows); } catch (err) { alert('Error: ' + err.message); } }

        document.getElementById('finalForm').addEventListener('submit', e => { e.preventDefault(); fetchData('final-data', e.target, finalCols, 'final'); });
        document.getElementById('tariffForm').addEventListener('submit', e => { e.preventDefault(); fetchData('tariffline-data', e.target, tariffCols, 'tariff'); });
        document.getElementById('columnFilterContainer').addEventListener('change', () => { if (lastData) renderTable(lastData); });
    </script>