<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="UTF-8" />
  <title>Comtrade API Tester</title>
</head>

<body>
  <h2>Comtrade API Query Panel</h2>
  <div class="flex">
    <form id="finalForm">
      <h3>Final Data Query</h3>
      <input name="typeCode" value="C" required><br>
      <input name="freqCode" value="M" required><br>
      <input name="clCode" value="HS" required><br>
      <input name="period" value="202205" required><br>
      <input name="reporterCode" value="36" required><br>
      <input name="cmdCode" value="91" required><br>
      <input name="flowCode" value="M" required><br>
      <button type="submit">Fetch Final Data</button>
    </form>

    <form id="tariffForm">
      <h3>Tariffline Data Query</h3>
      <input name="typeCode" value="C" required><br>
      <input name="freqCode" value="M" required><br>
      <input name="clCode" value="HS" required><br>
      <input name="period" value="202205" required><br>
      <input name="reporterCode" value="36" required><br>
      <input name="cmdCode" value="91" required><br>
      <input name="flowCode" value="M" required><br>
      <button type="submit">Fetch Tariffline Data</button>
    </form>
  </div>

  <div id="results">
    <h3>Results:</h3>
    <div class="column-filter" id="columnFilterContainer"></div>
    <div id="tableContainer">No data yet.</div>
  </div>

  <script>
    const CLOUD_RUN_BASE = "https://uncomtrade-web-app-903823352744.europe-west1.run.app";
    let lastData = null;

    const finalDefaultCols = [
      "refPeriodId", "reporterDesc", "partnerDesc", "customsCode", "motDesc",
      "altQty", "netWgt", "grossWgt", "cifvalue", "fobvalue", "primaryValue"
    ];

    const tariffDefaultCols = [
      "refPeriodId", "reporterDesc", "partnerDesc", "cmdCode", "cmdDesc",
      "qty", "qtyUnitAbbr", "altQty", "netWgt", "grossWgt", "fobvalue"
    ];

    function renderColumnFilter(columns, defaultChecked) {
      const container = document.getElementById("columnFilterContainer");
      container.innerHTML = "";
      const allKeys = Object.keys(columns[0] ?? {});
      allKeys.forEach(key => {
        const isChecked = defaultChecked.includes(key);
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" value="${key}" ${isChecked ? "checked" : ""}>${key}`;
        container.appendChild(label);
      });
    }

    function getSelectedColumns() {
      return Array.from(document.querySelectorAll('#columnFilterContainer input:checked')).map(i => i.value);
    }

    function renderTable(data) {
      lastData = data;
      const selectedColumns = getSelectedColumns();
      let html = "<table><thead><tr>" + selectedColumns.map(k => `<th>${k}</th>`).join("") + "</tr></thead><tbody>";

      html += data.map(row => {
        return "<tr>" + selectedColumns.map(k => {
          let value = row[k] ?? "";
          if (k === "motDesc") {
            if (value.toLowerCase().includes("air")) value = "‚úàÔ∏è " + value;
            else if (value.toLowerCase().includes("sea")) value = "üö¢ " + value;
          }
          return `<td>${value}</td>`;
        }).join("") + "</tr>";
      }).join("");

      html += "</tbody></table>";
      document.getElementById("tableContainer").innerHTML = html;
    }

    async function handleForm(endpoint, form, defaultCols) {
      const params = new URLSearchParams(new FormData(form)).toString();
      const res = await fetch(`${CLOUD_RUN_BASE}/${endpoint}?${params}`);
      const json = await res.json();
      renderColumnFilter(json, defaultCols);
      renderTable(json);
    }

    document.getElementById("finalForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      await handleForm("final-data", e.target, finalDefaultCols);
    });

    document.getElementById("tariffForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      await handleForm("tariffline-data", e.target, tariffDefaultCols);
    });

    document.getElementById("columnFilterContainer").addEventListener("change", () => {
      if (lastData) renderTable(lastData);
    });
  </script>

  <div>&copy; True Digital Team 2025</div>
</body>

</html>